# README `nvme-scan`

Helper script to scan for nvme devices and build a local json file containing various
device details.

Dependencies:
* nvme-cli
* lspci
* udevadm
* find
* (optional) spdk source code

This script can scan for details of a specified device, or scan for ALL devices.
Scan for ALL is handy for launching a new test suite before any potential problems
occur.  The specified device scan is handy for detecting changes to a previous
scan; such as device path changes or namespace drops.

A typical scan does the following:
1. Look for PCIe device and match to kernel driver dev node.
    * report any anomalies if the device node is missing (problem with driver init)
1. Collect latest details of controller and namespace configuration.
1. Place data into a dictionary object and provide the ability to save to a json file.

## Scan ALL

Scan ALL does the following operations to build its data set when scanning
for ALL device details.

Command Line Options:
* No other arguments passed, except the option to scan ALL differences
* (optional) perform "diff" scan using previous data (file): `-f <data_file_path>`
    * e.g. `-f last_run_20201119.json`

Pseudo Code: (complete scan - no diff scan)
1. List all "Non-volatile" pci devices and their PCIe BDF identifiers
1. List all NVMe driver bindings to each PCIe device
    * This will be done different for SPDK versus inbox device drivers
    * Use the --spdk option to indicate use of SPDK user space drivers
1. Collect NVMe device controller configuration details
    * Create map of device serial number and model number
    * Create list of PCIe BDF and device reference nodes or names.
    * Dual port drives will have one ore more PCIe BDFs and kernel device 
      nodes to the same serial number.
1. Collect NVMe device namespace details and add to device map.
    * Each drive serial number will get a list of namespace id objects.
    * Each namespace id object has a device reference node or name,
      and any information available about its namespace.

## Scan device 

Scan device takes one of two types of device inputs PCIe DBDF or kernel device
reference name.  It also takes as input the data set generated by a previous
run.  On the command line this would be a file name, through the class instance
it is a dictionary object; which can be loaded from file, or built at runtime.

Command Line Options:
* Scan by BDF: `-b <pcie D:B:D.F>`
    * e.g. `-b 0000:02:00.0`
* Scan by Name: `-n <nvme dev node>`
    * e.g. `-n /dev/nvme0`
* Device data (file): `-f <data_file_path>`
    * e.g. `-f last_run_20201119.json`
    